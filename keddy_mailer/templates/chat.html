{% extends "userhome.html" %}

{% load static %}

{% block topbar %}
{% endblock %}

{% block summary_content %}
{% endblock %}

{% block other %}
{% endblock %}

{% block outermain %}{% endblock %}
{% block main %} {% endblock %}

{% block topbar1 %}
{% endblock %}

{% block top_campaigns %}

<style>
    .userchat-container {
        background: #ffffff;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        border: 1px solid #8FABD4;
        display: flex;
        flex-direction: column;
        height: 80vh;
        min-height: 500px;
    }

    .userchat-header {
        background: linear-gradient(135deg, #8FABD4 0%, #4A70A9 100%);
        color: #ffffff;
        padding: 12px 20px;
        font-size: 1.25rem;
        font-weight: bold;
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
        border-bottom: 1px solid #8FABD4;
        flex-shrink: 0;
    }

    .userchat-body {
        flex-grow: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
        background-color: #EFECE3;
        min-height: 0;
    }

    .userchat-message {
        max-width: 75%;
        padding: 12px 16px;
        border-radius: 18px;
        margin-bottom: 12px;
        font-size: 0.95rem;
        word-wrap: break-word;
    }

    .userchat-sent {
        align-self: flex-end;
        background: linear-gradient(135deg, #8FABD4 0%, #4A70A9 100%);
        color: #ffffff;
        border-bottom-right-radius: 4px;
    }

    .userchat-received {
        align-self: flex-start;
        background: #ffffff;
        color: #000000;
        border: 1px solid #8FABD4;
        border-bottom-left-radius: 4px;
    }

    .userchat-footer {
        padding: 16px 20px;
        background: #EFECE3;
        display: flex;
        gap: 12px;
        align-items: center;
        border-top: 1px solid #8FABD4;
        flex-shrink: 0;
    }

    .userchat-footer input {
        flex-grow: 1;
        border: 1px solid #8FABD4;
        border-radius: 8px;
        padding: 10px 16px;
        font-size: 14px;
        background: #ffffff;
        color: #000000;
    }

    .userchat-footer input:focus {
        outline: none;
        border-color: #4A70A9;
        box-shadow: 0 0 0 3px rgba(74, 112, 169, 0.1);
    }

    .userchat-footer input::placeholder {
        color: #8FABD4;
    }

    .userchat-send-btn {
        background: linear-gradient(135deg, #8FABD4 0%, #4A70A9 100%);
        border: none;
        border-radius: 8px;
        padding: 10px 20px;
        color: #ffffff;
        font-weight: 500;
        cursor: pointer;
        min-width: 80px;
    }

    .userchat-timestamp {
        font-size: 11px;
        display: block;
        margin-top: 6px;
        opacity: 0.7;
    }

    .userchat-sent .userchat-timestamp {
        color: rgba(255, 255, 255, 0.8);
    }

    .userchat-received .userchat-timestamp {
        color: #8FABD4;
    }

    /* Scrollbar styling */
    .userchat-body::-webkit-scrollbar {
        width: 6px;
    }

    .userchat-body::-webkit-scrollbar-track {
        background: #EFECE3;
    }

    .userchat-body::-webkit-scrollbar-thumb {
        background: #8FABD4;
        border-radius: 3px;
    }

    /* Empty state */
    .userchat-empty {
        text-align: center;
        color: #8FABD4;
        padding: 40px 20px;
        margin: auto;
    }

    .userchat-empty i {
        font-size: 48px;
        margin-bottom: 16px;
        display: block;
    }

    @media (max-width: 768px) {
        .userchat-container {
            height: 75vh;
        }

        .userchat-header {
            padding: 10px 16px;
            font-size: 1.1rem;
        }

        .userchat-body {
            padding: 16px;
        }

        .userchat-footer {
            padding: 12px 16px;
            gap: 10px;
        }

        .userchat-message {
            max-width: 85%;
            padding: 10px 14px;
            font-size: 0.9rem;
        }

        .userchat-footer input {
            padding: 8px 12px;
            font-size: 13px;
        }

        .userchat-send-btn {
            padding: 8px 16px;
            min-width: 70px;
            font-size: 13px;
        }
    }

    @media (max-width: 576px) {
        .userchat-container {
            height: 70vh;
            border-radius: 8px;
        }

        .userchat-header {
            border-radius: 8px 8px 0 0;
        }

        .userchat-body {
            padding: 12px;
        }

        .userchat-footer {
            padding: 10px 12px;
            flex-direction: column;
            gap: 8px;
        }

        .userchat-footer input {
            width: 100%;
        }

        .userchat-send-btn {
            width: 100%;
        }

        .userchat-message {
            max-width: 90%;
        }
    }
</style>

<div class="container-fluid py-3">
    <div class="userchat-container">
        <div class="userchat-header">
            <i class="bi bi-chat-dots me-2"></i>Chat with Admin
        </div>
        <div class="userchat-body" id="userchat-messages">
            <div class="userchat-empty" id="empty-state">
                <i class="bi bi-chat-square-text"></i>
                <p>Loading messages...</p>
            </div>
        </div>

        <div class="userchat-footer">
            <input type="text" class="form-control" id="userchat-input" placeholder="Type your message...">
            <button class="userchat-send-btn" id="userchat-send-btn">
                <i class="bi bi-send me-1"></i> Send
            </button>
        </div>
    </div>
</div>

<script>
    // Move script to top and ensure it runs immediately
    document.addEventListener('DOMContentLoaded', function() {
        initializeChat();
    });

    function initializeChat() {
        const receiverEmail = "admin@example.com";
        
        // Load messages immediately
        fetchMessages();
        
        // Set up event listeners
        document.getElementById("userchat-send-btn").addEventListener("click", sendMessage);

        document.getElementById("userchat-input").addEventListener("keypress", function(e) {
            if (e.key === "Enter") {
                sendMessage();
            }
        });

        // Auto-refresh messages every 5 seconds
        setInterval(fetchMessages, 5000);
        
        // Focus input
        document.getElementById("userchat-input").focus();
    }

    function fetchMessages() {
        fetch("/fetch_messages/")
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    const chatBox = document.getElementById("userchat-messages");
                    const emptyState = document.getElementById("empty-state");
                    
                    if (data.messages && data.messages.length > 0) {
                        emptyState.style.display = 'none';
                        chatBox.innerHTML = '';
                        
                        data.messages.forEach(msg => {
                            const msgDiv = document.createElement("div");
                            msgDiv.classList.add("userchat-message");
                            
                            // Use the actual session email comparison
                            const isSent = msg.sender === "{{ request.session.email }}";
                            msgDiv.classList.add(isSent ? "userchat-sent" : "userchat-received");

                            msgDiv.innerHTML = `
                                ${msg.message}
                                <span class="userchat-timestamp">${msg.time}</span>
                            `;
                            chatBox.appendChild(msgDiv);
                        });
                    } else {
                        emptyState.style.display = 'block';
                        emptyState.innerHTML = `
                            <i class="bi bi-chat-square-text"></i>
                            <p>No messages yet. Start a conversation!</p>
                        `;
                    }

                    // Scroll to bottom
                    chatBox.scrollTop = chatBox.scrollHeight;
                }
            })
            .catch(error => {
                console.error('Error fetching messages:', error);
                const emptyState = document.getElementById("empty-state");
                emptyState.innerHTML = `
                    <i class="bi bi-exclamation-triangle"></i>
                    <p>Error loading messages. Please refresh the page.</p>
                `;
            });
    }

    function sendMessage() {
        const msgInput = document.getElementById("userchat-input");
        const message = msgInput.value.trim();
        if (!message) return;

        const sendBtn = document.getElementById("userchat-send-btn");
        const originalText = sendBtn.innerHTML;
        
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<i class="bi bi-clock me-1"></i> Sending...';

        fetch("/send_message/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({
                receiver_email: "admin@example.com",
                message: message
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "success") {
                msgInput.value = "";
                fetchMessages(); // Reload messages after sending
            } else {
                alert('Failed to send message: ' + (data.message || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error sending message:', error);
            alert('Failed to send message. Please try again.');
        })
        .finally(() => {
            sendBtn.disabled = false;
            sendBtn.innerHTML = originalText;
        });
    }

    // Fallback: if DOMContentLoaded doesn't fire, run after short delay
    setTimeout(function() {
        if (!document.getElementById("userchat-messages").hasChildNodes()) {
            initializeChat();
        }
    }, 100);
</script>
{% endblock %}




{% comment %} {% extends "userhome.html" %}

{% load static %}

{% block topbar %}
{% endblock %}

{% block summary_content %}
{% endblock %}

{% block other %}
{% endblock %}

{% block outermain %}{% endblock %}
{% block main %} {% endblock %}

{% block topbar1 %}
{% endblock %}

{% block top_campaigns %}


<style>
    .userchat-container {
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        height: 92vh;
        max-height: 92vh;
        max-width: 1020px;
    }

    .userchat-header {
        background-color: #3b82f6;
        color: #fff;
        padding: 8px 20px;
        font-size: 1.25rem;
        font-weight: bold;
        border-top-left-radius: 12px;
        border-top-right-radius: 12px;
    }

    .userchat-body {
        flex-grow: 1;
        overflow-y: auto;
        padding: 20px;
        display: flex;
        flex-direction: column;
    }

    .userchat-message {
        max-width: 75%;
        padding: 10px 15px;
        border-radius: 20px;
        margin-bottom: 10px;
        font-size: 0.95rem;
        word-wrap: break-word;
    }

    .userchat-sent {
        align-self: flex-end;
        background-color: #d1e7ff;
        color: #333;
        border-bottom-right-radius: 0;
    }

    .userchat-received {
        align-self: flex-start;
        background-color: #e4e6eb;
        color: #333;
        border-bottom-left-radius: 0;
    }

    .userchat-footer {
        padding: 10px 20px;
        background: #f8f9fa;
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
    }

    .userchat-footer input {
        flex-grow: 1;
    }

    .userchat-timestamp {
        font-size: 11px;
        display: block;
        margin-top: 5px;
        opacity: 0.6;
    }

    @media (max-width: 576px) {
        .userchat-container {
            height: 90vh;
            border-radius: 0;
        }

        .userchat-footer {
            padding: 10px;
        }

        .userchat-message {
            max-width: 90%;
            font-size: 0.9rem;
        }
    }
</style>

<div >
    <div class="userchat-container shadow-sm">
        <div class="userchat-header">Chat with Admin</div>
        <div class="userchat-body" id="userchat-messages"></div>

        <div class="userchat-footer">
            <input type="text" class="form-control" id="userchat-input" style="max-width:90%" placeholder="Type a message...">
            <button class="btn btn-primary" id="userchat-send-btn">Send</button>
        </div>
    </div>
</div>

<script>
    const receiverEmail = "admin@example.com";

    function fetchMessages() {
        fetch("/fetch_messages/")
            .then(response => response.json())
            .then(data => {
                if (data.status === "success") {
                    const chatBox = document.getElementById("userchat-messages");
                    chatBox.innerHTML = "";

                    data.messages.forEach(msg => {
                        const msgDiv = document.createElement("div");
                        msgDiv.classList.add("userchat-message");
                        msgDiv.classList.add(msg.sender === "{{ request.session.email }}" ? "userchat-sent" : "userchat-received");

                        msgDiv.innerHTML = `
                            ${msg.message}
                            <span class="userchat-timestamp">${msg.time}</span>
                        `;
                        chatBox.appendChild(msgDiv);
                    });

                    chatBox.scrollTop = chatBox.scrollHeight;
                }
            });
    }

    document.getElementById("userchat-send-btn").addEventListener("click", () => {
        const msgInput = document.getElementById("userchat-input");
        const message = msgInput.value.trim();
        if (!message) return;

        fetch("/send_message/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}"
            },
            body: JSON.stringify({
                receiver_email: receiverEmail,
                message: message
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "success") {
                msgInput.value = "";
                fetchMessages();
            }
        });
    });

    setInterval(fetchMessages, 5000);
    window.onload = fetchMessages;
</script>
{% endblock %} {% endcomment %}
